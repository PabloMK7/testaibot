name: Verify first-time contributor

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write

jobs:
  verify:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.issue.labels.*.name, 'needs verification')
    steps:
      - name: Verify and reopen PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const label = 'needs verification';

            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: issue.number,
            });
            
            if (comment.user.login !== pr.user.login) {
              return;
            }

            const { data: user } = await github.rest.users.getByUsername({
              username: pr.user.login,
            });

            const username = pr.user.login.toLowerCase();
            const displayName = (user.name || '').toLowerCase();
            const body = comment.body.toLowerCase().trim();

            async function removeLabel() {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: issue.number,
                  name: label,
                });
              } catch {}
            }

            const verified =
                body.split(/\s+/).includes(username) ||
                (displayName && body.split(/\s+/).includes(displayName));

            if (!verified) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: 'Verification failed! Pull request will remain closed.',
              });

              await removeLabel();
              return;
            }

            // Success â†’ reopen PR
            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: issue.number,
              state: 'open',
            });

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: 'Verification successful. Pull request has been reopened. You may also edit your PR description to remove the block of text.',
            });

            await removeLabel();